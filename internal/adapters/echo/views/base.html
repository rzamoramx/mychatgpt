{{define "base.html"}}
<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Bootstrap CSS -->
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.3.0/font/bootstrap-icons.css">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.css" rel="stylesheet" />

  <title>MyChatGpt</title>
</head>

<body>
  <!-- Top bar -->
  <nav class="navbar navbar-expand-lg navbar-light bg-dark">
    <div class="container">
      <a class="navbar-brand" href="#">
        <svg style="width: 100%" data-v-423bf9ae="" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 469 90"
          class="iconLeft"><!----><!----><!---->
          <g data-v-423bf9ae="" id="13b29b77-f59d-4b20-aa36-4af1a8d0ef7b" fill="#FFFFFF"
            transform="matrix(4.735595867300924,0,0,4.735595867300924,104.74348761944762,4.723755652985382)">
            <path
              d="M1.11 12.29L1.11 2.69L3.08 2.69L5.38 9.24L5.38 9.24Q5.50 9.60 5.63 10.07L5.63 10.07L5.63 10.07Q5.77 10.54 5.81 10.68L5.81 10.68L5.87 10.68L5.87 10.68Q5.91 10.53 6.04 10.04L6.04 10.04L6.04 10.04Q6.17 9.55 6.29 9.24L6.29 9.24L8.60 2.69L10.56 2.69L10.56 12.29L9.23 12.29L9.23 5.95L9.25 4.16L9.16 4.16L9.16 4.16Q9.14 4.26 9.07 4.56L9.07 4.56L9.07 4.56Q9.00 4.86 8.92 5.08L8.92 5.08L6.31 12.29L5.21 12.29L2.65 5.08L2.65 5.08Q2.58 4.89 2.50 4.57L2.50 4.57L2.50 4.57Q2.42 4.26 2.41 4.16L2.41 4.16L2.32 4.16L2.35 5.95L2.35 12.29L1.11 12.29ZM13.30 14.84L13.30 14.84Q12.68 14.84 12.32 14.73L12.32 14.73L12.32 13.93L12.81 13.93L12.81 13.93Q14.24 13.93 14.69 12.29L14.69 12.29L11.84 4.93L13.15 4.93L14.52 8.61L14.52 8.61Q14.71 9.13 14.97 9.90L14.97 9.90L14.97 9.90Q15.23 10.68 15.32 10.92L15.32 10.92L15.39 10.92L15.39 10.92Q15.46 10.68 15.65 10.02L15.65 10.02L15.65 10.02Q15.83 9.37 16.07 8.61L16.07 8.61L17.25 4.93L18.48 4.93L16.06 11.91L16.06 11.91Q15.57 13.31 14.95 14.08L14.95 14.08L14.95 14.08Q14.32 14.84 13.30 14.84L13.30 14.84ZM24.00 12.46L24.00 12.46Q21.67 12.46 20.50 11.22L20.50 11.22L20.50 11.22Q19.32 9.98 19.32 7.49L19.32 7.49L19.32 7.49Q19.32 5.00 20.50 3.76L20.50 3.76L20.50 3.76Q21.67 2.52 24.00 2.52L24.00 2.52L24.00 2.52Q25.87 2.52 27.00 3.45L27.00 3.45L27.00 3.45Q28.13 4.38 28.13 6.16L28.13 6.16L26.77 6.16L26.77 6.16Q26.77 4.93 26.03 4.29L26.03 4.29L26.03 4.29Q25.30 3.65 24.00 3.65L24.00 3.65L24.00 3.65Q22.30 3.65 21.50 4.55L21.50 4.55L21.50 4.55Q20.71 5.45 20.69 7.46L20.69 7.46L20.69 7.49L20.69 7.49Q20.69 9.52 21.49 10.42L21.49 10.42L21.49 10.42Q22.29 11.33 24.00 11.33L24.00 11.33L24.00 11.33Q25.33 11.33 26.07 10.70L26.07 10.70L26.07 10.70Q26.82 10.07 26.82 8.85L26.82 8.85L28.13 8.85L28.13 8.85Q28.13 10.64 27.01 11.55L27.01 11.55L27.01 11.55Q25.89 12.46 24.00 12.46L24.00 12.46ZM29.71 12.29L29.71 2.17L30.94 2.17L30.94 5.75L31.04 5.75L31.04 5.75Q31.81 4.76 33.36 4.76L33.36 4.76L33.36 4.76Q35.66 4.76 35.66 7.27L35.66 7.27L35.66 12.29L34.43 12.29L34.43 7.35L34.43 7.35Q34.43 6.47 34.03 6.13L34.03 6.13L34.03 6.13Q33.64 5.78 32.90 5.78L32.90 5.78L32.90 5.78Q32.37 5.78 31.92 6.04L31.92 6.04L31.92 6.04Q31.47 6.30 31.21 6.79L31.21 6.79L31.21 6.79Q30.94 7.28 30.94 7.94L30.94 7.94L30.94 12.29L29.71 12.29ZM39.49 12.46L39.49 12.46Q38.54 12.46 37.80 12.01L37.80 12.01L37.80 12.01Q37.06 11.56 37.06 10.39L37.06 10.39L37.06 10.39Q37.06 8.97 38.32 8.45L38.32 8.45L38.32 8.45Q39.58 7.92 41.96 7.92L41.96 7.92L41.96 7.11L41.96 7.11Q41.96 6.47 41.59 6.13L41.59 6.13L41.59 6.13Q41.23 5.78 40.28 5.78L40.28 5.78L40.28 5.78Q39.38 5.78 39.00 6.12L39.00 6.12L39.00 6.12Q38.61 6.45 38.61 6.94L38.61 6.94L38.61 7.11L37.42 7.11L37.42 7.11Q37.41 7.03 37.41 6.80L37.41 6.80L37.41 6.80Q37.41 5.82 38.22 5.29L38.22 5.29L38.22 5.29Q39.03 4.76 40.39 4.76L40.39 4.76L40.39 4.76Q41.76 4.76 42.48 5.33L42.48 5.33L42.48 5.33Q43.19 5.91 43.19 6.96L43.19 6.96L43.19 10.95L43.19 10.95Q43.19 11.20 43.33 11.32L43.33 11.32L43.33 11.32Q43.47 11.44 43.68 11.44L43.68 11.44L44.24 11.44L44.24 12.24L44.24 12.24Q43.88 12.40 43.29 12.40L43.29 12.40L43.29 12.40Q42.81 12.40 42.49 12.12L42.49 12.12L42.49 12.12Q42.17 11.83 42.06 11.35L42.06 11.35L41.96 11.35L41.96 11.35Q41.58 11.87 40.93 12.17L40.93 12.17L40.93 12.17Q40.28 12.46 39.49 12.46L39.49 12.46ZM39.82 11.44L39.82 11.44Q40.36 11.44 40.85 11.21L40.85 11.21L40.85 11.21Q41.34 10.99 41.65 10.55L41.65 10.55L41.65 10.55Q41.96 10.11 41.96 9.48L41.96 9.48L41.96 8.95L41.96 8.95Q40.15 8.95 39.25 9.23L39.25 9.23L39.25 9.23Q38.35 9.52 38.35 10.32L38.35 10.32L38.35 10.32Q38.35 10.92 38.72 11.18L38.72 11.18L38.72 11.18Q39.09 11.44 39.82 11.44L39.82 11.44ZM46.94 12.45L46.94 12.45Q46.19 12.45 45.84 12.00L45.84 12.00L45.84 12.00Q45.49 11.55 45.49 10.89L45.49 10.89L45.49 5.95L44.59 5.95L44.59 4.93L45.50 4.93L45.77 2.88L46.72 2.88L46.72 4.93L47.96 4.93L47.96 5.95L46.72 5.95L46.72 10.78L46.72 10.78Q46.72 11.44 47.33 11.44L47.33 11.44L47.96 11.44L47.96 12.25L47.96 12.25Q47.78 12.33 47.49 12.39L47.49 12.39L47.49 12.39Q47.19 12.45 46.94 12.45L46.94 12.45ZM53.41 8.46L53.41 7.29L58.13 7.29L58.13 12.29L57.09 12.29L56.99 11.23L56.99 11.23Q55.90 12.46 53.65 12.46L53.65 12.46L53.65 12.46Q51.30 12.46 50.09 11.22L50.09 11.22L50.09 11.22Q48.89 9.98 48.89 7.49L48.89 7.49L48.89 7.49Q48.89 2.52 53.73 2.52L53.73 2.52L53.73 2.52Q55.72 2.52 56.92 3.40L56.92 3.40L56.92 3.40Q58.13 4.28 58.13 5.96L58.13 5.96L56.77 5.96L56.77 5.96Q56.77 4.80 55.96 4.23L55.96 4.23L55.96 4.23Q55.15 3.65 53.73 3.65L53.73 3.65L53.73 3.65Q51.98 3.65 51.13 4.55L51.13 4.55L51.13 4.55Q50.27 5.45 50.27 7.49L50.27 7.49L50.27 7.52L50.27 7.52Q50.29 9.55 51.12 10.44L51.12 10.44L51.12 10.44Q51.95 11.33 53.65 11.33L53.65 11.33L53.65 11.33Q55.27 11.33 56.04 10.65L56.04 10.65L56.04 10.65Q56.80 9.98 56.80 8.60L56.80 8.60L56.80 8.46L53.41 8.46ZM60.23 12.29L60.23 2.69L64.90 2.69L64.90 2.69Q66.35 2.69 67.12 3.49L67.12 3.49L67.12 3.49Q67.89 4.28 67.89 5.61L67.89 5.61L67.89 5.61Q67.89 6.97 67.08 7.79L67.08 7.79L67.08 7.79Q66.28 8.61 64.90 8.61L64.90 8.61L61.56 8.61L61.56 12.29L60.23 12.29ZM61.56 7.45L64.83 7.45L64.83 7.45Q65.62 7.45 66.08 6.96L66.08 6.96L66.08 6.96Q66.54 6.47 66.54 5.63L66.54 5.63L66.54 5.63Q66.54 4.77 66.11 4.31L66.11 4.31L66.11 4.31Q65.67 3.85 64.83 3.85L64.83 3.85L61.56 3.85L61.56 7.45ZM72.07 12.29L72.07 3.85L68.77 3.85L68.77 2.69L76.71 2.69L76.71 3.85L73.40 3.85L73.40 12.29L72.07 12.29Z">
            </path>
          </g><!---->
          <g data-v-423bf9ae="" id="d1367cba-c81c-4468-a923-f874c66f1b16" transform="matrix(2.8125,0,0,2.8125,0,0)"
            stroke="none" fill="#45C6B1">
            <path d="M15.965 16.258l.707-.707 10.39 10.39-.707.707z"></path>
            <path d="M4.935 26.357L26.018 5.274l.707.707L5.642 27.065z"></path>
            <path
              d="M31 1v4.194h-4.194V1H31m1-1h-6.194v6.194H32V0zM31 26.806V31h-4.194v-4.194H31m1-1h-6.194V32H32v-6.194zM5.194 26.806V31H1v-4.194h4.194m1-1H0V32h6.194v-6.194z">
            </path>
          </g><!---->
        </svg>
      </a>
      <!-- Navigation menu button for small screens -->
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </div>
  </nav>

  <div class="container-fluid">
    <div class="row">
      <!-- Navigation left bar -->
      <nav class="col-md-4 col-lg-3 d-md-block bg-light sidebar">
        <br>
        <div class="sidebar-sticky">
          <ul class="list-group" id="history_chats">
            <li class="alert alert-info">Historial</li>
            <li class="alert alert-info">
              <div class="d-flex justify-content-between">
                <div class="btn btn-primary" id="newChat">New Chat</div>
                <select id="gpt-model" class="form-select" aria-label="Default select example">
                  <option selected value="1">gpt-4o</option>
                  <option value="2">gpt-4o-mini</option>
                  <option value="3">gpt-4-turbo</option>
                </select>
              </div>
            </li>

            {{range $idx, $history := .Histories}}
            <li id="{{.id}}" class="list-group-item"><i id="del{{.Id}}" class="bi bi-sm bi-trash"></i>{{.name}}</li>
            {{end}}
          </ul>
        </div>
      </nav>

      <!-- Container -->
      <main role="main" class="col-md-8 ml-sm-auto col-lg-9 pt-3 px-4">
        <div class="container">
          {{template "body" .}}
        </div>
      </main>
    </div>
  </div>

  <!-- jQuery y Bootstrap JS -->
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>

  {{template "js" .}}
  <script>
    var globalActualHistoryId = "";

    // add clik event to all history chats, and delete event to all delete buttons too
    {{range $idx, $history := .Histories}}
    $('#{{.id}}').on('click', function () {
      // clear chat-box
      $("#chat-box").html("");
      getMessages($(this).attr('id'));
    });

    $('#del{{.id}}').on('click', function () {
      // ask confirmation before delete
      var r = confirm("Estas seguro de borrar este chat?");
      if (r == false) {
        return;
      }

      $.ajax({
        url: "{{$.BaseUrl}}/v1/history/{{.id}}",
        type: "DELETE",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
          // remove li from list
          $('#{{.id}}').remove();
          // clear chat-box
          $("#chat-box").html("");
          console.log(data);
        },
        failure: function (errMsg) {
          console.log(errMsg);
          alert(errMsg);
        }
      });
    });
    {{end}}

    $(document).ready(function () {
      $('#newChat').click(function () {
        // ask for name of the new chat
        var name = prompt("Please enter the name of the new chat", "New Chat");

        $.ajax({
          url: "{{.BaseUrl}}/v1/history",
          type: "POST",
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          data: JSON.stringify({
            "name": name
          }),
          success: function (data) {
            globalActualHistoryId = data["id"];

            $('#history_chats li').removeClass('active');

            var newLi = $('<li>').attr('id', data["id"]).addClass('list-group-item active').html('<i class="bi bi-sm bi-trash"></i>&nbsp; ' + name);

            $('#history_chats').append(newLi);
            newLi.on('click', function () {
              // clear chat-box
              $("#chat-box").html("");
              getMessages($(this).attr('id'));
            });

            // clean chat-box
            $("#chat-box").html("");

            console.log(data);
          },
          failure: function (errMsg) {
            console.log(errMsg);
            alert(errMsg);
          }
        });
      });

      $('#gpt-model').change(function () {
        $.ajax({
          url: "{{.BaseUrl}}/v1/chat/opeaimodel",
          type: "PATCH",
          contentType: "application/json; charset=utf-8",
          dataType: "json",
          data: JSON.stringify({
            "open_ai_model": $(this).val()
          }),
          success: function (data) {
            console.log(data);
          },
          failure: function (errMsg) {
            console.log(errMsg);
            alert(errMsg);
          }
        });
      });

      $("#gpt-model").val("{{.OpenAiModel}}");
    });

    // function that retrieve messages by globalActualHistoryId
    function getMessages(idElement) {
      globalActualHistoryId = idElement;
      $.ajax({
        url: "{{.BaseUrl}}/v1/history/" + globalActualHistoryId,
        type: "GET",
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function (data) {
          // set css class "active" to the selected chat
          $('#history_chats li').removeClass('active');
          $('#' + idElement).addClass('active');

          // for data.messages append to chat-box
          for (var i = 0; i < data.messages.length; i++) {
            var message = data.messages[i];
            if (message.from == "user") {
              $("#chat-box").append(
                '<div class="row">' +
                '    <div class="col-2">&nbsp;</div>' +
                '    <div class="col-10 text-right">' +
                '        <div class="outgoing-message alert alert-success">' +
                message.text +
                '        </div>' +
                '    </div>' +
                '</div>'
              );
            } else {
              $("#chat-box").append(
                '<div class="row">' +
                '    <div class="col-10 text-left">' +
                '        <div class="incoming-message alert alert-primary">' +
                message.text +
                '        </div>' +
                '    </div>' +
                '    <div class="col-2">&nbsp;</div>' +
                '</div>'
              );
            }
          }
        },
        failure: function (errMsg) {
          console.log(errMsg);
          alert(errMsg);
        }
      });
    }

    $.getScript("https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js", function () {
      Prism.highlightAll();
    });
  </script>
</body>

</html>
{{end}}
